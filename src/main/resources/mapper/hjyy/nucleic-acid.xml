<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.julong.nucleicacid.dao.NucleicAcidMapper">

    <select id="getGeneratorNo" resultType="java.lang.String">
        select lpad( to_char(CURRENTNO) ,nolength , nvl(prefix,'0') )  from SM_NOGENERATOR where notype = #{noType}
    </select>

    <select id="getOutpatientInfo" resultType="com.julong.nucleicacid.model.OutpatientInfoOut">
        select
        --patientId	res	String	是	患者ID
        to_char(pat.PATIENTID) AS patientId,
        --patientName	res	String	是	患者姓名
        pat.NAME AS patientName,
        --gender	res	String	是	用户性别：M-男性 F-女性
        decode(pat.SEX,1,'M',2,'F',to_char(pat.SEX)) AS gender,
        --healthCardNo	res	String	是	健康卡号码
        pat.HCNO AS healthCardNo,
        --idCardNo	res	String	否	身份证
        pat.IDNO AS idCardNo,
        --birthday	res	String	否	出生日期
        to_char(pat.BIRTHPLACE, 'yyyy-MM-dd') AS birthday,
        --oppatNo	res	String	否	患者病历号
        '-' AS oppatNo,
        --phone	res	String	否	联系电话
        pat.MOBILE AS phone,
        --medicareCardNo	res	String	否	医保卡号
        '-' AS medicareCardNo,
        --homeAddress	res	String	否	家庭住址
        pat.ADDRESS AS homeAddress,
        --remark	res	String	否	备注
        '-' AS remark,
        --feeType	res	String	否	结算类型代码，1.医保 2自费 3公医 4省医
        decode(pat.PAYORID, 3,'2',4,'3',9,'4',to_char(pat.PAYORID)) AS feeType,
        --userTag	res	String	否	用户标签
        '-' AS userTag
        from PA_DATA_PATIENT pat
        <where>
            <if test=" idCardNo!=null and idCardNo !=''">
            and pat.IDNO = #{idCardNo}
            </if>
            <if test=" healthCardNo!=null and healthCardNo !=''">
            AND pat.HCNO = #{healthCardNo}
            </if>
            <if test=" patientId!=null and patientId !=''">
            AND to_char(pat.PATIENTID) = #{patientId}
            </if>

        </where>
    </select>
    <select id="nucleicGetItem" resultType="com.julong.nucleicacid.model.GetItemOutSet">
        select
        --itemId	set	String	是	套餐代码
        to_char(abo.ITEMID) AS itemId,
        --itemName	set	String	是	套餐名称
        abo.ITEMNAME AS itemName,
        --totalFee	set	String	是	套餐总金额，单位：分
        abo.PRICE AS totalFee
        from AB_ORDERITEM abo, AB_ORDERGROUPITEM abg
        where abg.ITEMID = abo.ITEMID and abg.GROUPID = #{groupId}


    </select>
    <select id="getGroupItems" resultType="java.lang.Long">
        select a.ITEMID as xmid  from  AB_ORDERGROUPITEM  a
		where a.GROUPID = #{groupId}
    </select>
    <select id="getGroupUnitPrice" resultType="java.math.BigDecimal">
        select sum(nvl(b.CLPRICE,0) ) as zdj from AB_ORDERGROUP a , ab_orderitem b , AB_ORDERGROUPITEM r
		where a.GROUPID = r.GROUPID and r.ITEMID = b.ITEMID and a.GROUPID = #{groupId}
    </select>
    <select id="getGroupAmount" resultType="java.math.BigDecimal">
        select sum( nvl(r.AMOUNT,1)  * nvl(b.CLPRICE,0) ) as zdj from AB_ORDERGROUP a , ab_orderitem b  , AB_ORDERGROUPITEM r
		where  a.GROUPID = r.GROUPID and r.ITEMID = b.ITEMID and a.GROUPID = #{groupId}

    </select>
    <select id="getOrderItemPretype" resultType="java.lang.Long">
        select nvl( p.PRETYPE,2)  as lb   from ab_orderitem o , PC_PRESCRIPTIONSUBCATALOG p
		where o.CATALOGID = p.PRESUBCATAID and o.ITEMID = #{itemId}
    </select>
    <select id="">
       --/**clinicSeq	payListInfo	String	是	就诊流水号*/
       --/**clinicTime	payListInfo	String	是	就诊日期*/
       --/**hospitalId	payListInfo	String	是	医院代码*/
       --/**deptId	payListInfo	String	是	接诊科室代码*/
       --/**deptName	payListInfo	String	是	接诊科室名称*/
       --/**doctorId	payListInfo	String	是	接诊医生代码*/
       --/**doctorName	payListInfo	String	是	接诊医生姓名*/
       --/**payAmout	payListInfo	String	是	自费金额(单位：分)*/
       --/**recPayAmout	payListInfo	String	是	统筹金额(单位：分)*/
       --/**totalPayAmout	payListInfo	String	是	总金额(单位：分)*/
       --/**receiptId	payListInfo	String	是	收据ID*/
       --/**chargeDate	payListInfo	String	是	缴费日期*/
       --/**remark	payListInfo	String	否	备注*/
       --/**orderId	payListInfo	String	否	支付平台订单号*/
       --/**allowRefund	payListInfo	String	否	是否允许退费，1表示允许退费，0表示不允许，默认值为0*/
       --/**prescriptionIds	payListInfo	String	否	处方号,允许线上退费时必须*/
       --/**refundType	payListInfo	String	否	退费方式，线上退费填"online"*/
       --/**refundNo	payListInfo	String	否	退费流水号，refundStatus=1或者2时必须*/
       --/**refundStatus	payListInfo	orderInfo	否	退费状态 0已支付1退费中 2 已退费*/
       --/**refundFee	payListInfo	String	否	退费自费金额，单位分*/
       --/**refundTime	payListInfo	String	否	退费时间yyyy-MM-dd HH:mm:ss*/
       --/**hasExpress	payListInfo	String	否	是否有药品快递信息 1包含 0不包含*/
       --/**deliveryStatus	payListInfo	String	否	药品物流状态 0 或空，不支持配送 1 可配送 2 已配送*/
       --/**medicineCode	payListInfo	String	否	取药码*/
       --/**pickUpLocation	payListInfo	String	否	取药药房*/
    </select>
    <select id="getUnChrgRecipeFO" resultType="com.julong.nucleicacid.entity.UnChrgRecipeFO">
        select
            to_char( cf.RECIPEID ) as RECIPEID,
            to_char( cf.PATIENTID ) as PATIENTID,
            nvl( to_char(cf.deptid),'-1') as deptid
        from pc_cl_data_recipe cf , pa_data_patient br
        where cf.PATIENTID = br.PATIENTID
        and br.HCNO = :cardNo
        and not exists ( select cf1.recipeid  from pc_cl_data_recipe cf1 where cf1.ENCOUNTERID = cf.ENCOUNTERID
          and nvl(cf1.SOCIALTYPE,'9') &lt;> '9'   and cf1.isdelete = '0' and cf1.ischarge = '0'
        )   --处方中的自费
        and br.ISDELETE = '0'  and cf.ISDELETE = '0' and cf.isCharge = '0'
       and to_char(cf.INPUTTIME,'yyyy-mm-dd') > to_char(sysdate - :limitDay , 'yyyy-mm-dd')
        and to_char(cf.INPUTTIME,'yyyy-mm-dd') between :beginDate and  :endDate
    order by cf.PATIENTID,cf.ENCOUNTERID,cf.RECIPEID

    </select>
    <select id="getPayInfo" resultType="com.julong.nucleicacid.model.GetPayInfoOutSet">
    select
    --clinicSeq	payListInfo	String	是	就诊流水号
    to_char(cf.ENCOUNTERID) AS clinicSeq,
    --clinicTime	payListInfo	String	是	就诊日期
    to_char(cf.INPUTTIME,'yyyy-MM-dd') AS clinicTime,
    --hospitalId	payListInfo	String	是	医院代码
    '-' AS hospitalId,
    --deptId	payListInfo	String	是	接诊科室代码
    to_char(cf.DEPTID) AS deptId,
    --deptName	payListInfo	String	是	接诊科室名称
    (select DEPTNAME from OM_DEPARTMENT where DEPTID=cf.DEPTID ) AS deptName,
    --doctorId	payListInfo	String	是	接诊医生代码
    to_char(cf.DOCID) AS doctorId,
    --doctorName	payListInfo	String	是	接诊医生姓名
    (select USERNAME from SM_USER where USERID= cf.DOCID) AS doctorName,
    --payAmout	payListInfo	String	是	未缴费总金额，单位：分
    (select to_char( sum(  nvl( decode( pce.ISCHARGE , '1' ,  pce.AMOUNT,0 ),0)))  from PC_CL_DATA_RECIPEENTRY pce where pce.RECIPEID = cf.RECIPEID) AS payAmout,
    --settleCode	payListInfo	String	是	结算类型代码，自费00
    '00' AS settleCode,
    --必填参数，，否则页面会显示null
    --settleType	payListInfo	String	否	结算类型名称,自费时可空
    '' AS settleType,
    --outpatientType	payListInfo	String	否	诊间支付类型：	（空字符串或0：普通线上诊间支付模式；1：充值模式）
    '' AS outpatientType,
    --prescriptionIds	payListInfo	String	否	处方号
    to_char( cf.RECIPEID ) AS prescriptionIds,
    --isFirstPay	payListInfo	String	否	是否优先支付 1是0 否
    '' AS isFirstPay
    --
    from pc_cl_data_recipe cf , pa_data_patient br
    where cf.PATIENTID = br.PATIENTID
      and not exists ( select cf1.recipeid  from pc_cl_data_recipe cf1 where cf1.ENCOUNTERID = cf.ENCOUNTERID
                                                                         and nvl(cf1.SOCIALTYPE,'9') != '9'   and cf1.isdelete = '0' and cf1.ischarge = '0'
        )   --处方中的自费
      and br.ISDELETE = '0'  and cf.ISDELETE = '0' and cf.isCharge = '0'
      and to_char(cf.INPUTTIME,'yyyy-mm-dd') > to_char(sysdate - :limitDay , 'yyyy-mm-dd')
      and to_char(cf.INPUTTIME,'yyyy-mm-dd') between :beginDate and  :endDate
      and br.HCNO = :cardNo
    order by cf.PATIENTID,cf.ENCOUNTERID,cf.RECIPEID
    </select>

</mapper>